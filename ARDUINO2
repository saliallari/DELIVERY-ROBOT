#include <Servo.h>                           //Î•Î›Î•Î“Î§ÎŸÎ£ SERVO ÎšÎ™ÎÎ—Î¤Î—Î¡Î•Î£
#include <ThreeWire.h>                       // Î•Î Î™ÎšÎŸÎ™ÎÎ©ÎÎ™Î‘ ÎœÎ• ÎŸÎ¡Î™Î£ÎœÎ•ÎÎ‘ RTC Î¡ÎŸÎ›ÎŸÎ“Î™Î‘
#include <RtcDS1302.h>                       // Î— Î’Î™Î’Î›Î™ÎŸÎ˜Î—ÎšÎ— Î“Î™Î‘ Î¡ÎŸÎ›ÎŸÎ™ Î Î¡Î‘Î“ÎœÎ‘Î¤Î™ÎšÎŸÎ¥ Î§Î¡ÎŸÎÎŸÎ¥
#include <TM1637Display.h>                   //ÎŸÎ˜ÎŸÎÎ— 4 Î¨Î—Î¦Î™Î©Î Î”Î•Î™Î§ÎÎ•Î™ Î©Î¡Î‘ Î‘Î¡Î™Î˜ÎœÎŸÎ¥Î£ Î“Î¡Î‘ÎœÎœÎ‘Î¤Î‘
#include <ArduinoJson.h>                     // Î•Î Î™Î¤Î¡Î•Î Î•Î™ ÎÎ‘ Î”Î™Î‘Î’Î‘Î–Î•Î™Î£ JSON Î”Î•Î”ÎŸÎœÎ•ÎÎ‘ Î•Î Î™ÎšÎŸÎ™ÎÎ©ÎÎ™Î‘ Î¥Î ÎŸÎ›ÎŸÎ“Î™Î£Î¤Î— ÎœÎ• Î‘Î›Î›Î— Î£Î¥Î£ÎšÎ•Î¥Î—
#include <Wire.h>                            // Î•Î Î™ÎšÎŸÎ™ÎÎ©ÎÎ™Î‘ ÎœÎ• Î¤ÎŸ ÎœPU6050 
#include <MPU6050.h>                         //Î•Î›Î•Î“Î§Î•Î™ Î¤ÎŸÎ Î‘Î™Î£Î˜Î—Î¤Î—Î¡Î‘ MPU6050
#include <math.h>                            //ÎœÎ‘Î˜Î—ÎœÎ‘Î¤Î™ÎšÎ•Î£ Î£Î¥Î‘ÎÎ¡Î¤Î—Î£Î•Î™Î£ SIN COS ABS ATAN SQRT



MPU6050 mpu;

int16_t ax, ay, az;                       // EÎ Î™Î¤Î‘Î§Î¥ÎÎ£Î™ÎŸÎœÎ•Î¤Î¡ÎŸ
int16_t gx, gy, gz;                       //Î“Î¥Î¡ÎŸÎ£ÎšÎŸÎ Î™ÎŸ 



float pitch = 0.0;                          //Î”Î—Î›Î©Î£Î— Î“Î©ÎÎ™Î‘Î£ Î•ÎœÎ Î¡ÎŸÎ£/Î Î™Î£Î©   0.0 Î‘Î¡Î‘ ÎÎ•ÎšÎ™ÎÎ‘Î•Î™ Î•Î¥Î˜Î•Î™Î‘
float roll = 0.0;                          //Î”Î—Î›Î©Î£Î—  Î“Î©ÎÎ™Î‘Î£ ÎšÎ›Î™Î£Î— Î‘Î¡Î™Î£Î¤Î•Î¡Î‘ Î”Î•ÎÎ™Î‘



const float MAX_SAFE_ANGLE = 15.0;          // ÎšÎ‘Î˜ÎŸÎ¡Î™Î–ÎŸÎ¥ÎœÎ• Î¤Î—Î£ ÎœÎŸÎ™Î¡Î•Î£ Î‘Î ÎŸ Î¤Î—Î Î‘Î¡Î§Î— Î”Î—Î›Î‘Î”Î— Î¤ÎŸ Î•Î Î™Î¤Î¡Î•Î Î¤Î© ÎŸÎ¡Î™ÎŸ Î¤Î—Î£ ÎœÎŸÎ™Î¡Î‘Î£ Î ÎŸÎ¥ ÎœÎ ÎŸÎ¡Î•Î™ ÎÎ‘ ÎšÎŸÎ¥ÎÎ—Î˜Î•Î™ 
bool robotTipped = false;                   // Î”Î•Î™Î§ÎÎ•Î™ Î‘Î Î¤ÎŸ Î¡ÎŸÎœÎ ÎŸÎ¤ Î•Î§Î•Î™ Î‘ÎÎ‘Î¤Î¡Î‘Î Î•Î™



const float SHAKE_THRESHOLD_G = 1.3;                      // ÎšÎ‘Î˜ÎŸÎ¡Î™Î–ÎŸÎ¥ÎœÎ• Î¤Î—Î Î”Î¥ÎÎ‘ÎœÎ— Î ÎŸÎ¥ ÎœÎ ÎŸÎ¡Î•Î™ ÎÎ‘ Î”Î•Î§Î¤Î•Î™ Î”Î—Î›Î‘Î”Î—Î›Î” Î¤ÎŸ Î¤Î¡Î‘ÎÎ¤Î‘Î“ÎœÎ‘ 
const float FREE_FALL_THRESHOLD_G = 0.62;                 // Î‘Î Î¤ÎŸ ÎŸÎ¡Î™ÎŸ Î Î¤Î©Î£Î•Î™Î£ Î•Î™ÎÎ‘Î™ Î Î‘ÎÎ© Î‘Î ÎŸ 0.62  (Î— Î•Î§Î•Î™ Î Î•Î£Î•Î™ Î— Î¥ÎŸ Î£Î—ÎšÎ©Î£Î‘Î)



float axg, ayg, azg;                                      //Î”Î—Î›Î©Î£Î— ÎœÎ•Î¤Î‘Î’Î›Î—Î¤Î©Î Î“Î™Î‘ Î¤Î—Î Î•Î Î™Î¤Î‘Î§Î¥ÎÎ£Î— Î£Î¤ÎŸÎ¥Î£ Î¤Î¡Î•Î™Î£ Î‘ÎÎŸÎÎ•Î£



bool shakeDetected = false;                               //Î”Î•Î™Î§ÎÎ•Î™ Î‘Î Î•Î§Î•Î™ ÎšÎŸÎ¥ÎÎ—Î˜Î•Î™ Î¤ÎŸ Î¡ÎŸÎœÎ ÎŸÎ¤
bool pickupDetected = false;                              //Î”Î•Î™Î§ÎÎ•Î™ Î‘Î Î•Î§Î•Î™ Î Î•Î£Î•Î™ Î¤ÎŸ Î¡ÎŸÎœÎ ÎŸÎ¤ Î— Î¤ÎŸ Î Î‘Î™Î¡ÎÎŸÎ¥Î 
bool inSafeMode = false;                                  // ÎœÎ Î‘Î™ÎÎ•Î™ Î£Î• ÎœÎŸÎ¥ÎÎ¤ Î Î¡ÎŸÎ£Î¤Î‘Î£Î™Î‘Î£ Î”Î—Î›Î‘Î”Î— Î£Î¤Î‘ÎœÎ‘Î¤Î‘Î•Î™ ÎÎ‘ ÎšÎ™ÎÎ•Î™Î¤Î‘Î™ ÎšÎ‘Î™ Î”Î•Î™Î§ÎÎ•Î™ Î Î¡ÎŸÎ•Î™Î”ÎŸÎ ÎŸÎ™Î—Î£Î—




StaticJsonDocument<200> doc;                              //Î¦Î¤Î‘Î™Î§ÎÎ•Î™ Î•ÎÎ‘ Î‘ÎÎ¤Î™ÎšÎ•Î™ÎœÎ•ÎÎŸ JSON Î“Î™Î‘ ÎÎ‘ Î‘Î ÎŸÎ˜Î—ÎšÎ•Î¥Î•Î™ Î£Î•Î£ÎŸÎœÎ•ÎÎ‘ Î ÎŸÎ¥ Î˜Î‘ Î£Î¤Î•Î›ÎÎ•Î™ Î¤ÎŸ Î¡ÎŸÎœÎ ÎŸÎ¤ doc["Posture"] = "Robot upright";
String jsonString;



const int motor1pin1 = 6;
const int motor1pin2 = 7;
const int ENA        = 5;
const int motor2pin1 = 8;
const int motor2pin2 = 9;
const int ENB        = 10;

int motorSpeed = 255;



Servo myServo;
const int servoPin = 11;
int  servoPos      = 90;
const int STEP     = 5;
bool servoUp   = false;
bool servoDown = false;



const unsigned long SERVO_PERIOD  = 30;                  //Î‘Î›Î‘Î“Î•Î™ Î¤ÎŸÎ¥ SERVO Î£Î• ÎšÎ‘Î˜Î• ÎšÎ™ÎÎ—Î£Î— ÎšÎ‘Î˜Î• 30MS  
unsigned long       lastServoTick = 0;                   //ÎšÎ¡Î‘Î¤Î‘Î•Î™ Î¤Î—Î Î¤Î•Î›Î•Î¥Î¤Î‘Î™Î‘ ÎšÎ™ÎÎ—Î£Î— Î¤ÎŸÎ¥ SERVO  Î‘Î¡Î‘ ÎŸÎ¤Î‘Î Î Î•Î¡Î‘Î£ÎŸÎ¥Î 30ÎœÎœÎ£ Î¸Î‘ ÎšÎ‘ÎÎ•Î™ Î¤Î—Î ÎšÎ™ÎÎ—Î£Î— 5 Î£Î¤Î•Î 




#define DS1302_DAT 12
#define DS1302_CLK 13
#define DS1302_RST 4
ThreeWire myWire(DS1302_DAT, DS1302_CLK, DS1302_RST);
RtcDS1302<ThreeWire> Rtc(myWire);        //Î”Î™Î‘Î’Î‘Î–Î•Î™ ÎšÎ‘Î™ Î¡Î¥Î˜ÎœÎ™Î–Î•Î™ Î¤Î—Î Î©Î¡Î‘ ÎšÎ‘Î™ Î¤Î—Î Î—ÎœÎ•Î¡ÎŸÎœÎ—ÎÎ™Î‘ Î“Î™Î‘ Î¤ÎŸ RCT




#define TM_CLK 2                                                //ÎŸÎ¡Î™Î–Î•Î™ Î¤ÎŸ PIN2  Î˜Î‘ Î£Î¥ÎÎ”Î•Î˜Î•Î™ ÎœÎ• Î¤ÎŸ CLOCK Î¤Î—Î£ ÎŸÎ˜ÎŸÎÎ—Î£ TM1637
#define TM_DIO 3                                                //ÎŸÎ¡Î™Î–Î•Î™ Î¤ÎŸ PIN3 Î˜Î‘ Î£Î¥ÎÎ”Î•Î˜Î•Î™ ÎœÎ• Î¤ÎŸ DIO  Î¤Î‘ Î”Î•Î”ÎŸÎœÎ•ÎÎ‘ Î”Î›Î” Î¤Î—Î£ ÎŸÎ˜ÎŸÎÎ—Î£ 
TM1637Display display(TM_CLK, TM_DIO);                          // Î¦Î¤Î™Î‘Î§ÎÎ•Î™ Î¤ÎŸ Î‘ÎÎ¤Î™ÎšÎ•Î™ÎœÎ•ÎÎŸ DISPLAY Î“Î™Î‘ ÎÎ‘ Î•Î›Î•Î“Î§Î•Î™ Î¤Î—Î ÎŸÎ˜ÎŸÎÎ— Î¤Îœ1637




bool showColon = true;                                          // Î•Î”Î© Î’Î“Î‘Î–Î•Î™ Î¤Î—Î : Î“Î™Î‘ ÎÎ‘ Î¦Î‘Î™ÎÎ•Î¤Î‘Î™ Î£Î‘Î Î Î¡Î‘Î“ÎœÎ‘Î¤Î™ÎšÎŸ Î¡ÎŸÎ›ÎŸÎ™ Î£Î¤Î—Î ÎŸÎ˜ÎŸÎÎ—
unsigned long lastColonToggle = 0;                              // Î˜Î¥ÎœÎ‘Î¤Î‘Î™ Î ÎŸÎ¤Î• Î•Î“Î™ÎÎ• Î— Î¤Î•Î›Î•Î¤Î‘Î¥Î™Î‘ Î‘Î›Î‘Î“Î— Î“Î™Î‘ ÎÎ‘ Î•ÎœÎ¦Î‘ÎÎ™Î–Î•Î™ Î¤ÎŸ :
const unsigned long COLON_PERIOD = 500;                         //: Î˜Î‘ Î¤ÎŸ Î‘Î›Î›Î‘Î–Î•Î™ ÎšÎ‘Î˜Î• 500MS
unsigned long lastClockUpdate = 0;                              //Î ÎŸÎ¤Î• Î•ÎÎ—ÎœÎ•Î¡Î©Î˜Î—ÎšÎ• Î¤Î•Î›Î•Î¤Î‘Î¥Î‘ Î¦ÎŸÎ¡Î‘ Î— Î©Î¡Î‘ 
const unsigned long CLOCK_PERIOD = 1000;                        // Î— Î©Î¡Î‘ Î¤Î—Î£ ÎŸÎ˜ÎŸÎÎ—Î£ Î˜Î‘ Î‘ÎÎ‘ÎÎ•Î©ÎÎ•Î¤Î• ÎšÎ‘Î˜Î• 1MS




void stopMotors();
void moveForward();
void moveBackward();
void turnLeft();
void turnRight();





void setup() {

  Serial.begin(9600);


  pinMode(motor1pin1, OUTPUT);
  pinMode(motor1pin2, OUTPUT);
  pinMode(motor2pin1, OUTPUT);
  pinMode(motor2pin2, OUTPUT);
  pinMode(ENA, OUTPUT);
  pinMode(ENB, OUTPUT);


  myServo.attach(servoPin);
  myServo.write(servoPos);


  display.setBrightness(0x0f);       // MÎ•Î“Î™Î£Î¤Î— Î¦Î©Î¤Î•Î™ÎÎ©Î¤Î—Î¤Î‘ Î“Î™Î‘ Î¤Î—Î ÎŸÎ˜ÎŸÎÎ—




  Rtc.Begin();                                            // ÎÎ•ÎšÎ™ÎÎ‘Î™Î• Î— Î•Î Î™ÎšÎŸÎ™ÎšÎŸÎ™ÎÎ©ÎÎ™Î‘ ÎœÎ• Î¤ÎŸ RTC
  if (!Rtc.IsDateTimeValid()) {                           // Î’Î›Î•Î Î•Î™ Î‘Î Î•Î§Î•Î™ Î¤Î—Î ÎšÎ‘ÎÎŸÎÎ™ÎšÎ“ Î—ÎœÎ•Î¡ÎŸÎœÎ™ÎÎ—Î‘ Î— Î©Î¡Î‘ Î‘Î Î”Î•Î Î•Î§Î•Î™ Î•Î™ÎÎ‘Î™ Î›Î‘Î˜ÎŸÎ£ 
    RtcDateTime compiled(__DATE__, __TIME__);             // Î’Î›Î•Î Î•Î™ Î¤Î—Î Î Î¡Î‘Î“ÎœÎ‘Î¤Î™ÎšÎ— Î—ÎœÎ•Î¡ÎŸÎœÎ—ÎÎ™Î‘ ÎšÎ‘Î™ Î©Î¡Î‘ Î ÎŸÎ¥ Î•Î“Î™ÎÎ• Î— Î¡Î¥Î˜ÎœÎ™Î£Î— 
    Rtc.SetDateTime(compiled);                            // Î˜Î•Î›Î© Î¤Î—Î Î Î©Î¡Î‘ Î ÎŸÎ¥ Î•Î¦Î¤Î™Î‘ÎÎ‘ Î£Î¤Î—Î Î Î¡ÎŸÎ™Î“ÎŸÎ¥ÎœÎ•ÎÎ— Î“Î¡Î‘ÎœÎœÎ— 
  } 


  if (!Rtc.GetIsRunning()) Rtc.SetIsRunning(true);

  Wire.begin();                                           // ÎÎ•ÎšÎ™ÎÎ‘Î•Î™ Î¤Î—Î Î•Î Î™ÎšÎŸÎ™ÎÎ©ÎÎ™Î‘ ÎœÎ• Î‘Î›Î›Î‘ Î•ÎÎ‘Î¡Î¤Î—ÎœÎ‘Î¤Î‘  
  Serial.println("Initializing MPU6050...");              // ÎÎ•ÎšÎ™ÎÎ‘Î•Î™ Î¤ÎŸ MPY3060 
  mpu.initialize();
  if (mpu.testConnection()) {
    Serial.println("âœ… MPU6050 connection successful!");             // Î‘Î Î•Î™ÎÎ‘Î™ Î£Î©Î£Î¤Î— Î— Î”Î¥ÎÎ”Î•Î£Î— Î•Î™ÎÎ‘Î™ Î•ÎÎ¤Î‘ÎÎ— 
  } else {
    Serial.println("âŒ MPU6050 connection failed!");                 // Î‘Î›Î›Î™Î©Î£ Î‘Î Î”Î•Î Î•Î™ÎÎ‘Î™  Î’Î‘Î“Î–Î•Î™ Î•Î¡Î¡ÎŸÎ¡ 
    while (1);
  }



  stopMotors();
  Serial.println(F("Robot + Servo + Clock ready."));              // Î£Î¤Î—Î Î‘Î¡Î§Î— Î¤ÎŸÎ¥ ÎšÎ©Î”Î™ÎšÎ‘ Î•Î™ÎÎ‘Î™ ÎŸÎ›Î‘ ÎšÎ›Î•Î™Î£Î¤Î‘ Î“Î™Î‘Î¥Î¤ÎŸ Î’Î‘Î–ÎŸÎ¥ÎœÎ• Î£Î¤ÎŸÎ  ÎœÎŸÎ¤ÎŸÎ¡ Î‘Î›Î›Î™Î©Î£ Î‘Î Î”Î•Î Î‘Î’Î‘Î–Î‘ ÎšÎ‘Î¤Î™ Î¤ÎŸ ÎœÎŸÎ¤ÎŸÎ¡ ÎšÎ‘Î™ Î¤ÎŸ Î£Î•Î¡Î’ÎŸ Î˜Î‘ ÎšÎ™ÎÎŸÎ¥Î¤Î‘Î
}



void loop() {
  if (Serial.available()) {
    String command = Serial.readStringUntil('\n');
    command.trim();            // Î‘Î¦Î‘Î™Î¡Î•Î™ Î¤Î¥Î§ÎŸÎ ÎšÎ•ÎÎ‘ Î‘Î›Î›Î‘Î“Î•Î£ Î“Î¡Î‘ÎœÎœÎ•Î£ Î‘Î ÎŸ Î¤Î— ÎÎ‘Î¡Î§Î— ÎšÎ‘Î™ Î£Î¤ÎŸ Î¤Î•Î›ÎŸÎ£Î” Î¤ÎŸÎ¥ ÎœÎ—ÎÎ—Î‘ÎœÎ¤ÎŸÏ‚ 


    if (command == "f") moveForward();               //Î£Î¤Î•Î™Î›Î‘ÎœÎ• F Î Î‘Î•Î™ ÎœÎ Î¡ÎŸÎ£Î¤Î‘
    else if (command == "b") moveBackward();         //Î£Î¤Î•Î™Î›Î‘ÎœÎ• b Î Î‘Î•Î™ Î Î™Î£Î©        
    else if (command == "r") turnLeft();             //Î£Î¤Î•Î™Î›Î‘ÎœÎ• r Î Î‘Î•Î™ Î‘Î¡Î™Î£Î¤Î•Î¡Î‘
    else if (command == "l") turnRight();            //Î£Î¤Î•Î™Î›Î‘ÎœÎ• l Î Î‘Î•Î™ Î”Î•ÎÎ™Î‘
    else if (command == "s") stopMotors();           //Î£Î¤Î•Î™Î›Î‘ÎœÎ• s Î Î‘Î•Î™ Î£Î¤Î‘ÎœÎ‘Î¤Î‘Î•Î™
    else if (command.startsWith("speed")) {         //
      int v = command.substring(5).toInt();           //  Î•Î”Î© Î¡Î¥Î˜ÎœÎ™Î–Î© Î¤Î—Î Î¤Î‘Î§Î¥Î¤Î‘ Î¤ÎŸÎ¥ Î¡ÎŸÎœÎ ÎŸÎ¤ Î ÎŸÎ£ÎŸ Î¤ÎŸ Î˜Î•Î›Î©        
      if (v >= 0 && v <= 255) motorSpeed = v;       //    
    }


    else if (command == "servo_up_start") 
    { servoUp = true; servoDown = false; }                // ÎšÎ™ÎÎ—Î£Î— Î£Î•Î¡Î’ÎŸ Î Î¡ÎŸÎ£ Î¤Î‘ Î Î‘ÎÎ© 


    else if (command == "servo_up_stop")                 // ÎšÎ™ÎÎ—Î£Î— Î£Î•Î¡Î’ÎŸ Î Î‘ÎÎ©  ((((Î£Î¤ÎŸÎ ))))
      { servoUp = false; }


    else if (command == "servo_down_start")              // ÎšÎ™ÎÎ—Î£Î—   Î£Î•Î¡Î’ÎŸ Î Î¡ÎŸÎ£ Î¤Î‘ ÎšÎ‘Î¤Î©
     { servoDown = true; servoUp = false; }


    else if (command == "servo_down_stop")               // ÎšÎ™ÎÎ—Î£Î— Î£Î•Î¡Î’ÎŸ ÎšÎ‘Î¤Î©  ((((Î£Î¤ÎŸÎ ))))
    
     { servoDown = false; }
  }




  unsigned long now = millis();

  if (now - lastServoTick >= SERVO_PERIOD) {
    lastServoTick = now;
    if (servoUp && servoPos < 180) {
      servoPos += STEP;                                   // Î‘Ï…Î¾Î¬Î½Î¿Ï…Î¼Îµ Ï„Î· Î¸Î­ÏƒÎ· Ï„Î¿Ï… servo ÎºÎ±Ï„Î¬ 5 Î¼Î¿Î¯ÏÎµÏ‚.
      myServo.write(servoPos);
    }
    if (servoDown && servoPos > 0) {
      servoPos -= STEP;                                  // ÎœÎµÎ¹ÏÎ½Î¿Ï…Î¼Îµ Ï„Î· Î¸Î­ÏƒÎ· Ï„Î¿Ï… servo ÎºÎ±Ï„Î¬ 5 Î¼Î¿Î¯ÏÎµÏ‚.

      myServo.write(servoPos);
    }
  }



  if (now - lastColonToggle >= COLON_PERIOD) {
    showColon = !showColon;
    lastColonToggle = now;
  }

  if (now - lastClockUpdate >= CLOCK_PERIOD) {
    lastClockUpdate = now;
    RtcDateTime t = Rtc.GetDateTime();
    uint16_t hhmm = t.Hour() * 100 + t.Minute();
    uint8_t mask = showColon ? 0b11100000 : 0;
    display.showNumberDecEx(hhmm, mask, true);
  }

  updateTiltAngles();
}




// AYTO TO VOID Î•Î™ÎÎ‘Î™ Î“Î™Î‘ ÎÎ‘ ÎœÎ‘Î£ Î”Î•Î™ÎÎ•Î™ Î¤Î—Î£ ÎœÎŸÎ™Î¡Î•Î£ Î¤ÎŸÎ¥ Î¡ÎŸÎœÎ ÎŸÎ¤ 
// Î£Î¤Î—Î Î‘Î¡Î§Î— Î”Î—Î›Î©Î£Î‘ÎœÎ• 15 ÎœÎŸÎ™Î¡Î•Î£ 
//Î‘Î ÎŸÎ™ÎŸ ÎœÎŸÎ™Î¡Î•Î£ Î•Î™ÎÎ‘Î™ Î Î‘Î¡Î‘Î Î‘ÎÎ© Î‘Î ÎŸ 15 Î˜Î‘ ÎœÎ‘Î£ Î’Î“Î‘Î›Î•Î™ Î‘Î¥Î¤ÎŸ Î¤ÎŸ ÎœÎ—ÎÎ—ÎœÎ‘ âš ï¸ WARNING: Robot tipped over!
//ÎšÎ‘Î™ Î˜Î‘ Î£Î¤Î‘ÎœÎ‘Î¤Î—Î£Î•Î™ Î¤ÎŸ ÎœÎŸÎ¤Î•Î¡ 

void updateTiltAngles() {
  int16_t axRaw, ayRaw, azRaw, gxRaw, gyRaw, gzRaw;
  mpu.getMotion6(&axRaw, &ayRaw, &azRaw, &gxRaw, &gyRaw, &gzRaw);

  axg = axRaw / 16384.0;
  ayg = ayRaw / 16384.0;
  azg = azRaw / 16384.0;

  pitch = atan2(axg, sqrt(ayg * ayg + azg * azg)) * 180 / PI;
  roll  = atan2(ayg, sqrt(axg * axg + azg * azg)) * 180 / PI;

  doc.clear();

  if (abs(pitch) > MAX_SAFE_ANGLE || abs(roll) > MAX_SAFE_ANGLE) {
    if (!robotTipped) {
      //stopMotors();
      robotTipped = true;
      //inSafeMode = true;
      doc["Tipped"] = "âš ï¸ WARNING: Robot tipped over!";
    }
  } else {
    robotTipped = false;            //Î‘Î½ Î´ÎµÎ½ Î­Ï‡ÎµÎ¹ Î³ÎµÎ¯ÏÎµÎ¹, ÎµÏ€Î±Î½Î±Ï†Î­ÏÎµÎ¹ Ï„Î¿ robotTipped ÏƒÎµ false.
  }

  detectMotionPatterns();
  classifyPosture();

  serializeJson(doc, jsonString);
  Serial.println(jsonString);
}






// Î•Î”Î© ÎŸ ÎšÎ©Î”Î™ÎšÎ‘Î£ Î•Î™ÎÎ‘Î™ Î“Î™Î‘ Î¤ÎŸ Î‘Î ÎšÎŸÎ¥ÎÎ—Î˜Î—ÎšÎ• Î¤ÎŸ Î¡ÎŸÎœÎ ÎŸÎ¤ 
// ÎšÎ‘Î™ Î“Î™Î‘ Î¤ÎŸ Î‘Î Î£Î—ÎšÎ©Î˜Î—ÎšÎ• Î— Î•Î Î•Î£Î• Î‘Î ÎŸÎ¤ÎŸÎœÎ‘ ÎšÎ‘Î¤Î©

void detectMotionPatterns() {
  float accMagnitude = sqrt(axg * axg + ayg * ayg + azg * azg);

  if (accMagnitude > SHAKE_THRESHOLD_G) {    // Î“Î™Î‘ Î Î‘Î¡Î‘Î”Î•Î™Î“ÎœÎ‘ Î§Î¤Î¥Î Î£Î—Î£Î• Î£Î• Î¤ÎŸÎ™Î§ÎŸ Î˜Î‘ Î’Î“Î‘Î›Î•Î™ Î‘Î¥Î¤ÎŸ Î¤ÎŸ ÎœÎÎœ "ğŸš¨ Shake/Impact detected!";
    if (!shakeDetected) {
      doc["Shake"] = "ğŸš¨ Shake/Impact detected!";
      shakeDetected = true;
      //stopMotors();
      //inSafeMode = true;
    }
  } else {
    shakeDetected = false;
  }

  if (abs(azg) < FREE_FALL_THRESHOLD_G) {   // Î“Î™Î‘ Î Î‘Î¡Î‘Î”Î•Î™Î“ÎœÎ‘ Î•Î Î•Î£Î• ÎšÎ‘Î¤Î© Î‘Î ÎŸÎ¤ÎŸÎœÎ‘ Î— Î¤Î¡Î‘Î’Î—Î§Î¤Î—ÎšÎ• Î‘Î ÎŸÎ¤ÎŸÎœÎ‘ Î‘Î ÎŸ Î¤ÎŸ Î Î‘Î¤Î©ÎœÎ‘ Î˜Î‘ Î’Î“Î‘Î›Î•Î™ Î‘Î¥Î¤ÎŸ Î¤ÎŸ ÎœÎ—ÎÎ—ÎœÎ‘  "âš ï¸ Pickup or free fall detected!";
    if (!pickupDetected) {
      doc["Pickup"] = "âš ï¸ Pickup or free fall detected!";
      pickupDetected = true;
      stopMotors();
      inSafeMode = true;
    }
  } else {
    pickupDetected = false;
  }
}




void classifyPosture() {
  String posture;
  const float G_THRESHOLD = 0.60;
  const float DOMINANCE_MARGIN = 0.20;

  bool axDominant = (abs(axg) > G_THRESHOLD) && (abs(axg) > abs(ayg) + DOMINANCE_MARGIN) && (abs(axg) > abs(azg) + DOMINANCE_MARGIN);
  bool ayDominant = (abs(ayg) > G_THRESHOLD) && (abs(ayg) > abs(axg) + DOMINANCE_MARGIN) && (abs(ayg) > abs(azg) + DOMINANCE_MARGIN);
  bool azDominant = (abs(azg) > G_THRESHOLD) && (abs(azg) > abs(axg) + DOMINANCE_MARGIN) && (abs(azg) > abs(ayg) + DOMINANCE_MARGIN);

  if (axDominant) {
    if (axg > 0) {
      posture = "ğŸ¤– Robot lying on its back";

      stopMotors();

      inSafeMode = true;

    } else {
      posture = "ğŸ¤– Robot lying on its front";
    }
  } else if (ayDominant) {
    if (ayg > 0) {
      posture = "ğŸ¤– Robot lying on its right side";

      stopMotors();

      inSafeMode = true;

    } else {
      posture = "ğŸ¤– Robot lying on its left side";

      stopMotors();

      inSafeMode = true;
    }
  } else if (azDominant) {
    if (azg > 0) {
      posture = "ğŸŸ¢ Robot upright";
    } else {
      posture = "ğŸ”„ Robot upside down";

      stopMotors();

      inSafeMode = true;
    }
  } else {
    posture = "â“ Unclear posture yet.";
  }

  doc["Posture"] = posture;
}







/* ---------- CHASSIS HELPERS ---------- */
void moveForward()
{
    analogWrite(ENA, motorSpeed);
    analogWrite(ENB, motorSpeed);
    digitalWrite(motor1pin1, LOW);  
    digitalWrite(motor1pin2, HIGH);
    digitalWrite(motor2pin1, LOW);  
    digitalWrite(motor2pin2, HIGH);
}



void moveBackward()
{
    analogWrite(ENA, motorSpeed);
    analogWrite(ENB, motorSpeed);
    digitalWrite(motor1pin1, HIGH);
    digitalWrite(motor1pin2, LOW);
    digitalWrite(motor2pin1, HIGH);
    digitalWrite(motor2pin2, LOW);
}



void stopMotors()
{
    analogWrite(ENA, 0);
    analogWrite(ENB, 0);
    digitalWrite(motor1pin1, LOW);
    digitalWrite(motor1pin2, LOW);
    digitalWrite(motor2pin1, LOW); 
    digitalWrite(motor2pin2, LOW);
}



void turnLeft()
{
    analogWrite(ENA, motorSpeed);
    analogWrite(ENB, motorSpeed);
    digitalWrite(motor1pin1, HIGH);
    digitalWrite(motor1pin2, LOW);   
    digitalWrite(motor2pin1, LOW); 
    digitalWrite(motor2pin2, HIGH);  
}



void turnRight()
{
    analogWrite(ENA, motorSpeed);
    analogWrite(ENB, motorSpeed);
    digitalWrite(motor1pin1, LOW);
    digitalWrite(motor1pin2, HIGH);  
    digitalWrite(motor2pin1, HIGH);
    digitalWrite(motor2pin2, LOW);   
}
